---
title: "data_preprocessing"
author: "Adam Drożyński"
date: "4/2/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(pacman)
p_load(tictoc,tidyverse,dplyr,broom,ggplot2,clubSandwich,
       data.table,matrixStats,magrittr,MASS,R.utils,
       stargazer,DT,furrr, lfe,estimatr,boot,plm,lmtest,multiwayvcov,
       sandwich,glmnet,ISLR, parallel, haven, MatchIt, optmatch, ipw, AER, rdd)
PATH_BHPS = '..\\UKDA-6614-stata\\stata\\stata13_se\\bhps\\'
# PATH_BHPS = '../UKDA-6614-stata/stata/stata13_se/bhps/'
PATH_UKHLS = '..\\UKDA-6614-stata\\stata\\stata13_se\\ukhls\\'
# PATH_UKHLS = '../UKDA-6614-stata/stata/stata13_se/ukhls/'
```


```{r}
get_full_label_bhps <- function(label, letter){
  return(paste0('b', letter, '_', label))
}

read_bhps_by_letter <- function(x){
  data <- read_stata(paste0(PATH_BHPS, 'b', x, '_youth.dta'))
  data <- data %>% dplyr::select(any_of(c('pidp', 
                         get_full_label_bhps('ypdoby', x),
                         get_full_label_bhps('ypsex', x),
                         get_full_label_bhps('ypnpal', x),
                         get_full_label_bhps('ypfpark', x),
                         get_full_label_bhps('ypmkfrn', x),
                         get_full_label_bhps('yppalo', x),
                         get_full_label_bhps('yppals', x),
                         get_full_label_bhps('ypsdqk', x)))) %>% 
          rename_with(~ 'birthy', all_of(get_full_label_bhps('ypdoby', x))) %>% 
          rename_with(~ 'sex', all_of(get_full_label_bhps('ypsex', x))) %>%
          rename_with(~ case_when(. == get_full_label_bhps('ypnpal', x) ~ 'ypnpal', 
                                  . == get_full_label_bhps('ypfpark', x) ~ 'ypfpark', 
                                  . == get_full_label_bhps('ypmkfrn', x) ~ 'ypmkfrn', 
                                  . == get_full_label_bhps('yppalo', x) ~ 'yppalo', 
                                  . == get_full_label_bhps('yppals', x) ~ 'yppals',
                                  . == get_full_label_bhps('ypsdqk', x) ~ 'ypsdqk',
                                  TRUE ~ .))
  data$birthy = ifelse(data$birthy > 1000, data$birthy, data$birthy + 1900)
  data$year = 1991 + (utf8ToInt(x) - utf8ToInt('a'))
  data$age = data$year - data$birthy
  return(data)
}


data_youth <- lapply(letters[4:18], read_bhps_by_letter)

data_youth_merged <- rbindlist(data_youth, fill = T)
```

```{r}
get_full_label_ukhls <- function(label, letter){
  return(paste0(letter, '_', label))
}

read_ukhls_by_letter <- function(x){
  data <- read_stata(paste0(PATH_UKHLS, x, '_indresp.dta'))
  data <- data %>% dplyr::select(any_of(c('pidp', 
                         get_full_label_ukhls('birthy', x),
                         get_full_label_ukhls('sex', x),
                         get_full_label_ukhls('adcts', x),
                         get_full_label_ukhls('memploy', x),
                         get_full_label_ukhls('fimnlabnet_dv', x)))) %>% 
          rename_with(~ 'birthy', all_of(get_full_label_ukhls('birthy', x))) %>% 
          rename_with(~ 'sex', all_of(get_full_label_ukhls('sex', x))) %>%
          rename_with(~ 'moved', all_of(get_full_label_ukhls('adcts', x))) %>%
          rename_with(~ 'memploy', all_of(get_full_label_ukhls('memploy', x))) %>%
          rename_with(~ 'income', all_of(get_full_label_ukhls('fimnlabnet_dv', x)))
  data$birthy = ifelse(data$birthy > 1000, data$birthy, data$birthy + 1900)
  data$year = 2009 + (utf8ToInt(x) - utf8ToInt('a'))
  data$age = year - birthy
  return(data)
}

data_adults <- lapply(letters[3:11], read_ukhls_by_letter)
data_adults_merged <- rbindlist(data_adults)
```

```{r}
full_data_merge <- data_youth_merged %>% 
  inner_join(data_adults_merged, by = c('pidp', 'birthy', 'sex'))
```

```{r}
data_youth_merged$bg_ypnpal_std = 
  (data_youth_merged$bg_ypnpal - mean(data_youth_merged$bg_ypnpal, na.rm=TRUE))/
  sd(data_youth_merged$bg_ypnpal, na.rm=TRUE)

data_youth_merged$bg_yppals_std = 
  (data_youth_merged$bg_yppals - mean(data_youth_merged$bg_yppals, na.rm=TRUE))/
  sd(data_youth_merged$bg_yppals, na.rm=TRUE)
  
mean(data_youth_merged$bg_ypnpal_std, na.rm=TRUE)
mean(data_youth_merged$bg_yppals_std, na.rm=TRUE)

cor(data_youth_merged$bg_ypnpal_std, data_youth_merged$bg_yppals_std, use="complete.obs")


plot(data_youth_merged$bg_ypnpal, data_youth_merged$bg_yppals)
```

```{r}
lm_1 <- lm(data = full_data_merge, i_income ~ birthy + bf_yppals + bf_ypnpal + bg_yppals + bg_ypnpal + bh_yppals + bh_ypnpal + bi_yppals + bi_ypnpal)

summary(lm_1)



```

```{r}


cor(data_youth_merged$bd_ypnpal, data_youth_merged$be_ypnpal, use="complete.obs")
cor(data_youth_merged$bh_ypnpal, data_youth_merged$bi_ypnpal, use="complete.obs")

mean(data_youth_merged$bh_ypnpal, na.rm=TRUE)


mean(data_youth_merged$bd_yppals, na.rm=TRUE)
mean(data_youth_merged$be_yppals, na.rm=TRUE)
mean(data_youth_merged$bf_yppals, na.rm=TRUE)
mean(data_youth_merged$bg_yppals, na.rm=TRUE)
mean(data_youth_merged$bh_yppals, na.rm=TRUE)
mean(data_youth_merged$bi_yppals, na.rm=TRUE)
mean(data_youth_merged$bj_yppals, na.rm=TRUE)
mean(data_youth_merged$bk_yppals, na.rm=TRUE)
mean(data_youth_merged$bl_yppals, na.rm=TRUE)
mean(data_youth_merged$bm_yppals, na.rm=TRUE)
mean(data_youth_merged$bn_yppals, na.rm=TRUE)
mean(data_youth_merged$bo_yppals, na.rm=TRUE)
mean(data_youth_merged$bp_yppals, na.rm=TRUE)
mean(data_youth_merged$br_yppals, na.rm=TRUE)
mean(data_youth_merged$bp_yppals, na.rm=TRUE)
mean(data_youth_merged$bq_yppals, na.rm=TRUE)


```

Moving
```{r}
data_adults_merged$moved_bin = 1*(data_adults_merged$moved == 1)
data_adults_merged$moved_for_job = 1*(data_adults_merged$memploy > 0)

data_adults_merged <- data_adults_merged %>% 
  group_by(pidp) %>% 
  arrange(year, .by_group = T) %>%
  mutate(moved_total = sum(moved_bin))

data_adults_merged <- data_adults_merged %>% 
  group_by(pidp) %>% 
  arrange(year, .by_group = T) %>%
  mutate(moved_for_job_total = sum(moved_for_job))

table(data_adults_merged$moved_total)
table(data_adults_merged$moved_for_job_total)

lm1 <- felm(income ~ moved_bin + moved_for_job | year + pidp | 0 | year, data = data_adults_merged)

summary(lm1)

#mean(data_adults_merged$income)

#summary(lm(ypnpal ~ year + age, data = data_youth_merged))


table(data_youth_merged$age)
```

Social skills
```{r}
data_youth_merged_13 <- data_youth_merged %>% dplyr::filter(age == 12)


full_data_merge <- data_adults_merged %>% 
  inner_join(data_youth_merged_13, by = c('pidp', 'birthy', 'sex'))


lm1 <- felm(income ~ I(moved == 1) + I(memploy > 0)  | year.x + pidp | 0 | year.x, data = full_data_merge)

#summary(lm1)

# 
#           rename_with(~ case_when(. == get_full_label_bhps('ypnpal', x) ~ 'ypnpal', 
#                                   . == get_full_label_bhps('ypfpark', x) ~ 'ypfpark', 
#                                   . == get_full_label_bhps('ypmkfrn', x) ~ 'ypmkfrn', 
#                                   . == get_full_label_bhps('yppalo', x) ~ 'yppalo', 
#                                   . == get_full_label_bhps('yppals', x) ~ 'yppals',
#                                   . == get_full_label_bhps('ypsdqk', x) ~ 'ypsdqk',
#                                   
summary(lm(moved_bin ~ ypnpal, data = full_data_merge))
summary(lm(moved_bin ~ ypfpark, data = full_data_merge))
summary(lm(moved_bin ~ ypmkfrn, data = full_data_merge))
summary(lm(moved_bin ~ yppalo, data = full_data_merge))
summary(lm(moved_bin ~ yppals, data = full_data_merge))

summary(lm(moved_for_job ~ ypnpal, data = full_data_merge))
summary(lm(moved_for_job ~ ypfpark, data = full_data_merge))
summary(lm(moved_for_job ~ ypmkfrn, data = full_data_merge))
summary(lm(moved_for_job ~ yppalo, data = full_data_merge))
summary(lm(moved_for_job ~ yppals, data = full_data_merge))

```
